#!/bin/bash +x
set -e
set -x

#define values
ip_gw=192.168.4.1/24
ip_mask=255.255.255.0
dhcp_start=192.168.4.10
dhcp_end=192.168.4.50

# This script has been tested with the "2020-02-05-raspbian-buster-lite" image.
#test super user
if [ "$EUID" -ne 0 ]
  then echo "Please run as root"
  exit
fi

#install
echo "Installing dependencies..."
apt-get update
apt-get install dnsmasq hostapd	
echo "done."

echo "stoping services..."
systemctl stop dnsmasq
systemctl stop hostapd


#select wlan
echo -e "-------Wireless card config-------\n"
listcard=$(iw dev | grep wlan  | cut -d" " -f2 )
oldIFS=$IFS
IFS=$'\n'
choices=($listcard)
IFS=$oldIFS

PS3="Select your wireless card: "
select answer in "${choices[@]}"; do
       for item in "${choices[@]}"; do
	   if [[ $item == $answer ]]; then
               break 2;
           fi
       done
done
wcard=$answer
echo "Adapter select:"$wcard


############update /etc/dhcpcd.conf

if  grep -q $wcard "/etc/dhcpcd.conf" ; then
    ip_only=$(echo "$ip_gw" | cut -d"/" -f 1)
    mask_only=$(echo "$ip_gw" | cut -d"/" -f 2)
    sed -i "s/$wcard/$wcard \n     static ip_address=$ip_only\/$mask_only \n      nohook wpa_supplicant/g" /etc/dhcpcd.conf 
else
    echo -e "interface  "$wcard"\n     static ip_address=$ip_gw \n      nohook  wpa_supplicant" >> /etc/dhcpcd.conf
fi 

# restart dhcpcd
service dhcpcd restart

##########config hostap

#default options hostap
if !  grep -q interface "/etc/default/hostapd" ; then

    echo -e "interface=wlan0" >> /etc/default/hostapd 
    echo -e "driver=nl80211" >> /etc/default/hostapd
    echo -e "ssid=NameOfNetwork" >> /etc/default/hostapd
    echo -e "hw_mode=g" >> /etc/default/hostapd
    echo -e "channel=7" >> /etc/default/hostapd
    echo -e "wmm_enabled=0" >> /etc/default/hostapd
    echo -e "macaddr_acl=0" >> /etc/default/hostapd
    echo -e "auth_algs=1" >> /etc/default/hostapd
    echo -e "ignore_broadcast_ssid=0" >> /etc/default/hostapd
    echo -e "wpa=2" >> /etc/default/hostapd
    echo -e "wpa_passphrase=AardvarkBadgerHedgehog" >> /etc/default/hostapd
    echo -e "wpa_key_mgmt=WPA-PSK" >> /etc/default/hostapd
    echo -e "wpa_pairwise=TKIP" >> /etc/default/hostapd
    echo -e "rsn_pairwise=CCMP" >> /etc/default/hostapd
fi

#config card
sed -i '/interface=/c\'interface=$wcard'' /etc/default/hostapd

#config bssid
ssid="$(uname -n)"
read -p "Intro your ssid name: " ssid
sed -i '/ssid=/c\'ssid=$ssid'' /etc/default/hostapd 

##config passpharse
echo -e "-------passpharse config-------\n"              
pass1=""
chrlen1=${#pass1}
pass2="a"
chrlen2=${#pass2}
while [[ pass1 != pass2 ]]
do
  while [[ $chrlen1 -le  8 ]]
  do              
    read -p "Intro your passpharse [ min 8 characters] : " pass1
    chrlen1=${#pass1}                
  done

  while [[ $chrlen2 -le  8 ]] 
  do              
    read -p "Confirm your passphrase, intro again : " pass2
    chrlen2=${#pass2}                
  done
done

sed -i '/wpa_passphrase=/c\'wpa_passphrase=$pass'' /etc/default/hostapd 

sed -i '/#DAEMON_CONF/c\'DAEMON_CONF="\"/etc/hostapd/hostapd.conf"\"'' /etc/default/hostapd 


##########config dnsmasq
#original config config
mv /etc/dnsmasq.conf /etc/dnsmasq.conf.orig

echo -e "bind-dynamic" >> /etc/dnsmasq.conf

listcard=$(ifconfig  | grep flags  | cut -d":" -f1 | grep -v lo )
oldIFS=$IFS
IFS=$'\n'
choices=($listcard)
IFS=$oldIFS

for item in "${choices[@]}"; do
    if [[ $item == $wcard ]]; then
          echo -e "interface=$wcard" >> /etc/default/hostapd 
    else
          echo -e "no-dhcp-interface=$item" >> /etc/default/hostapd 
    fi
done

#config dhcp range
echo -e "dhcp-range=interface:$wcard,$dhcp_start,$dhcp_end,$ip_mask,24h  " >> /etc/default/hostapd






####### run daemon
systemctl start 
systemctl start dnsmasq
sudo systemctl unmask hostapd
sudo systemctl enable hostapd
sudo systemctl start hostapd

######Enable ip forward
sed -i '/net.ipv4.ip_forward/c\'net.ipv4.ip_forward=1'' /etc/sysctl.conf


# Finished
echo
echo "hotspot has been installed."
	
